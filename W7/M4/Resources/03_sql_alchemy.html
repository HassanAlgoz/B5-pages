<!DOCTYPE html>
<html lang="en"><head>
<link href="../../../assets/icon.svg" rel="icon" type="image/svg+xml">
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-html/tabby.min.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.26">

  <meta name="author" content="malfadly@sdaia.gov.sa">
  <title>AI Pros Bootcamp – إطار بايثون لقواعد البيانات</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../../../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../../../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../../site_libs/revealjs/dist/theme/quarto-2476b6dbe24137c74cb80772f2f63bf0.css">
  <link rel="stylesheet" href="../../../assets/sdaia.scss">
  <link href="../../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../../../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../../../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <link rel="icon" href="../../../assets/icon.svg">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-image="../../../assets/anim.svg" data-background-opacity="0.1" class="quarto-title-block center">
  <h1 class="title">إطار بايثون لقواعد البيانات</h1>

<div class="quarto-title-authors">
</div>

</section>
<section class="slide level2">

<blockquote>
<p>يقال أن الخيمياء (Alchemy) تسعى لتحويل المعادن الرخيصة (مثل الرصاص) إلى معادن ثمينة (كالذهب).</p>
</blockquote>
<p>حزمة <a href="https://www.sqlalchemy.org/">SQLAlchemy</a> هي أشهر إطار للتعامل مع قواعد البيانات في بايثون. وهي تحل مجموعة إشكالات استعرضناها في نهاية درس وصل التطبيق بقاعدة البيانات، حيث تبيَّن أن <strong>السايق</strong> (Driver) <code>psycopg</code> هو فقط واحدٌ من مجموعة أدوات نحتاج إليها للتعامل مع نظم قواعد البيانات بسهولة.</p>
<p>من بين هذه الحلول مثلاً إدارة <strong>مجمع اتصالات</strong> (<a href="https://docs.sqlalchemy.org/en/20/core/pooling.html">Connection Pool</a>) مستمرَّة محفوظة في الذاكرة يتم استعمالها وإعادتها للمجمع وعدم إغلاقها؛ لأن عملية إنشاء اتصال جديد عملية بطيئة في الغاية.</p>
<p>تكتسب الحزمة البرمجية لقب <strong>إطار</strong> (Framework) عندما تفرض طريقة معيَّنة في التطوير (كتابة النص البرمجي أو ترتيب خطوات للعمل). وهذا التأطير يتم عن طريق تعريف كلمات جديدة للغة، وسياقات توضَع فيها لتنتج معاني محددة بعناية في شبكة مفاهيم هذا الإطار.</p>
</section>
<section id="تثبيت-الحزمة" class="slide level2">
<h2>تثبيت الحزمة</h2>
<p><a href="https://docs.sqlalchemy.org/en/20/intro.html#installation-guide">وطريقة التثبيت في الصفحة الرسمية</a> تدلنا على طريقة تثبيت الحزمة:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a></a><span class="ex">uv</span> add SQLAlchemy</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="المحرك" class="slide level2">
<h2>المحرك</h2>
<p>الجزء المحوري في الإطار هو المحرِّك (Engine) حيث يدير هو آلية إنشاء وحفظ الاتصالات وإعادتها واستعمالها مرة أخرى. وعادةً ما يكون المُحرِّك <strong>مُفردًا</strong> (Singleton) -أي: كائنًا فريدًا مشاعًا (global)- لكل قاعدة بيانات نريد التواصل معها.</p>
<p>فأولاً يجب إنشاء ملف قيَم متغيرات البيئة، على النحو التالي:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode numberSource .env number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1"><a></a>POSTGRES_USER=user123</span>
<span id="cb2-2"><a></a>POSTGRES_PASSWORD=secret123</span>
<span id="cb2-3"><a></a>POSTGRES_HOST=localhost</span>
<span id="cb2-4"><a></a>POSTGRES_DB=testdb</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وفيما يلي نُنشئ المحرِّك ونمرر له معلومات الاتصال بعد قراءتها من ملف <code>.env</code>، ونؤكد على ضرورة عدم وضع هذه القيَم مباشرة في النص البرمجي للتطبيق لأنها تتغير بحسب البئية التي يعمل فيها البرنامج:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a></a><span class="im">import</span> os</span>
<span id="cb3-2"><a></a></span>
<span id="cb3-3"><a></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb3-4"><a></a></span>
<span id="cb3-5"><a></a><span class="im">from</span> sqlalchemy <span class="im">import</span> URL</span>
<span id="cb3-6"><a></a><span class="im">from</span> sqlalchemy <span class="im">import</span> create_engine</span>
<span id="cb3-7"><a></a></span>
<span id="cb3-8"><a></a>load_dotenv()  <span class="co"># defaults to loading .env from current directory</span></span>
<span id="cb3-9"><a></a></span>
<span id="cb3-10"><a></a>engine <span class="op">=</span> create_engine(</span>
<span id="cb3-11"><a></a>    url<span class="op">=</span>URL.create(</span>
<span id="cb3-12"><a></a>        <span class="st">"postgresql+psycopg"</span>, <span class="co"># Dialect + Driver</span></span>
<span id="cb3-13"><a></a>        username<span class="op">=</span>os.getenv(<span class="st">"POSTGRES_USER"</span>),</span>
<span id="cb3-14"><a></a>        password<span class="op">=</span>os.getenv(<span class="st">"POSTGRES_PASSWORD"</span>),</span>
<span id="cb3-15"><a></a>        host<span class="op">=</span>os.getenv(<span class="st">"POSTGRES_HOST"</span>),</span>
<span id="cb3-16"><a></a>        database<span class="op">=</span>os.getenv(<span class="st">"POSTGRES_DB"</span>),</span>
<span id="cb3-17"><a></a>    )</span>
<span id="cb3-18"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وننبه على اختلاف يسير هنا وهو أن أول معطى في إنشاء <strong>نص الاتصال</strong> (Connection String) هو: <code>postgres+psycopg</code> وهو شيئان يصفل بينهما علامة <code>+</code> ولم نرَ هذا الأمر مُسبقًا عند مكتبة <code>psycopg</code>، وإليك معنى كل واحد منهما:</p>
<p>أما <code>postgres</code> فهي <strong>اللهجة</strong> (Dialect) وتقبل كذلك (<code>mysql</code> أو <code>sqlite</code> أو <code>mssql</code> أو <code>oracle</code> ونحوها). وذلك لضبط آلية تحويل تعبيرات SQL التي سنكتبها في بايثون إلى بحسب نظام قاعدة البيانات المستعمل.</p>
<p>وأما <code>psycopg</code> فهو <strong>السائق</strong> (Driver) وتقبل أيضًا (<code>mysqlclient</code> أو <code>pysqlite</code> أو <code>asyncpg</code> أو <code>pymysql</code> أو <code>pyodbc</code> أو <code>cx_oracle</code> ونحوها). وذلك لضبط آلية تحويل الأوامِر المتوافقة مع DB-API إلى ما يقابلها من تفاصيل بحسب نظام قاعدة البيانات المستعمل.</p>
<p>وسبب الفصل هو أن النظام الواحد قد يساق بطرقتين؛ فمثلاً: نظام ولجهة <code>postgres</code> قد تساق بالقديم (<code>psycopg2</code>) أو بالجديد -الذي هو الإصدار الثالث، لكن من غير الرقم 3- وهو (<code>psycopg</code>).</p>
</section>
<section id="تعريف-مخطط-البيانات-ddl" class="slide level2">
<h2>تعريف مخطط البيانات (DDL)</h2>
<p>تعريف البيانات يكون عن طريق <strong>البيانات الوصفية</strong> (Metadata)؛ وهو عادةً ما يكون <strong>مُفردًا</strong> (Singleton) -أي: كائنًا فريدًا مشاعًا-.</p>
<p>ويتم استيراد مفردات التعريف على النحو التالي:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a></a><span class="im">from</span> sqlalchemy.schema <span class="im">import</span> MetaData, Table, Column</span>
<span id="cb4-2"><a></a><span class="im">from</span> sqlalchemy.types <span class="im">import</span> Integer, String, Date</span>
<span id="cb4-3"><a></a></span>
<span id="cb4-4"><a></a>metadata <span class="op">=</span> MetaData()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>نعرف الجدول الأول: جدول المستخدمين:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a></a>users_table <span class="op">=</span> Table(</span>
<span id="cb5-2"><a></a>    <span class="st">"users"</span>,</span>
<span id="cb5-3"><a></a>    metadata,</span>
<span id="cb5-4"><a></a>    Column(<span class="st">"id"</span>, Integer, primary_key<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb5-5"><a></a>    Column(<span class="st">"name"</span>, String(<span class="dv">100</span>)),</span>
<span id="cb5-6"><a></a>    Column(<span class="st">"birth_date"</span>, Date)</span>
<span id="cb5-7"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>ثم سيتم تحويل هذا التعريف لاحقًا إلى هذا النص بلغة SQL:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> users (</span>
<span id="cb6-2"><a></a>    <span class="kw">id</span>   <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb6-3"><a></a>    name <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb6-4"><a></a>    birth_date <span class="dt">DATE</span>,</span>
<span id="cb6-5"><a></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>)</span>
<span id="cb6-6"><a></a>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وإليك <a href="https://docs.sqlalchemy.org/en/20/core/types.html">مرجع جميع أنواع SQL الممثلة في SQLAlchemy</a> لمعرفة ما يقابل كل نوع؛ كمعرفة أن <code>String</code> تحوَّل إلى VARCHAR مثلاً.</p>
<h3 id="القيود">القيود</h3>
<p>لتحديد <strong>القيود</strong> (Constraints) مثل أن يوجَد لكل عنوان المستخدم الذي ينسَب إليه هذا العنوان، فإننا نستعمل <strong>المفتاح الأجنبي</strong> (<code>ForeignKey</code>) في تعريف جدول العناوين بهذا الشكل:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a></a><span class="im">from</span> sqlalchemy.schema <span class="im">import</span> ForeignKey</span>
<span id="cb7-2"><a></a></span>
<span id="cb7-3"><a></a>user_emails_table <span class="op">=</span> Table(</span>
<span id="cb7-4"><a></a>    <span class="st">"user_emails"</span>,</span>
<span id="cb7-5"><a></a>    metadata,</span>
<span id="cb7-6"><a></a>    Column(<span class="st">"id"</span>, Integer, primary_key<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb7-7"><a></a>    Column(<span class="st">"user_id"</span>, ForeignKey(<span class="st">"users.id"</span>), nullable<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb7-8"><a></a>    Column(<span class="st">"email"</span>, String, nullable<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb7-9"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وإذا نظرنا إلى ترجمتها في SQL فيما بعد فستكون بهذا الشكل:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> user_emails (</span>
<span id="cb8-2"><a></a>    <span class="kw">id</span>      <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb8-3"><a></a>    user_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb8-4"><a></a>    email   <span class="dt">VARCHAR</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb8-5"><a></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>),</span>
<span id="cb8-6"><a></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span>(user_id) <span class="kw">REFERENCES</span> users (<span class="kw">id</span>)</span>
<span id="cb8-7"><a></a>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="تطبيق-التعريفات-على-قاعدة-البيانات">تطبيق التعريفات على قاعدة البيانات</h3>
<p>لا يتم إنشاء الجداول إلا حين نستعمل طريقة <code>create_all</code> من كائن <strong>البيانات الوصفية</strong> (Metadata)، وعكسه طريقة <code>drop_all</code>، وكلاهما يتطلَّب المحرِّك:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a></a>metadata.create_all(engine)</span>
<span id="cb9-2"><a></a><span class="co"># metadata.drop_all(engine)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>تنبيه</strong>: لدينا خلل كبير لم نعالجه بعد. فهذه الطريقة (<code>create_all</code> و <code>drop_all</code>) مدمِّرة للبيانات الموجودة! مما يجعلها صالحة للاستعمال في التجرِبة فقط. أما في تطوير البرمجيات في الواقع فعلينا استعمال آلية دقيقة في تتبع تطوُّر مخطط البيانات بحيث نستطيع التعديل من غير أن نفقد شيئًا من البيانات. وهذه الآلية معروفة باسم: الترحيل (Migrations)، وسيأتي الكلام عنها في الدرس القادم (متابعة تطوارات المخطط).</p>
</section>
<section id="عكس-التعريف-الموجود-في-قاعدة-البيانات-إلى-بايثون" class="slide level2">
<h2>عكس التعريف الموجود في قاعدة البيانات إلى بايثون</h2>
<p>ماذا لو كنت أعمل على مشروع تم تعريف البيانات فيه وأصبحت قاعدة البيانات مخططة، وأريد الآن أن أقرأ هذا التخطيط وأحوِّله إلى بايثون؟ هذه العملية تسمى <a href="https://docs.sqlalchemy.org/en/20/core/reflection.html"><strong>العكس</strong> (Reflection)</a>.</p>
</section>
<section id="العمل-مع-البيانات" class="slide level2">
<h2>العمل مع البيانات</h2>
<p>بعد أن رأينا تعريف الجداوِل وإنشاءها في قاعدة البيانات بالفعل. ننتقل إلى البيانات ونرى كيف يمكننا إطار SQLAlchemy من التعامل معها.</p>
<p>أولاً لاحظ أن العبارات تأتي من حزمة واحدة وهكذا تستورد:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a></a><span class="im">from</span> sqlalchemy.sql.expression <span class="im">import</span> insert, select, update, delete</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>ثم يمكن إنشاء الجُمَل في بايثون على النحو التالي:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb11-2"><a></a>    insert(users_table)</span>
<span id="cb11-3"><a></a>    .values(</span>
<span id="cb11-4"><a></a>        name<span class="op">=</span><span class="st">"Adam Banana"</span>,</span>
<span id="cb11-5"><a></a>        birth_date<span class="op">=</span>datetime.date(<span class="dv">1990</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb11-6"><a></a>    )</span>
<span id="cb11-7"><a></a>    .returning(users_table.c.<span class="bu">id</span>)</span>
<span id="cb11-8"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وهذه الجملة ستحوَّل إلى شيئين: الأمر بلغة SQL والمعطيات بجانبها:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (name, birth_date)</span>
<span id="cb12-2"><a></a><span class="kw">VALUES</span> (<span class="ch">:name</span>, <span class="ch">:birth_date</span>) <span class="kw">RETURNING</span> users.<span class="kw">id</span>;</span>
<span id="cb12-3"><a></a></span>
<span id="cb12-4"><a></a>{</span>
<span id="cb12-5"><a></a>  <span class="st">'name'</span>: <span class="st">'Adam Banana'</span>,</span>
<span id="cb12-6"><a></a>  <span class="st">'birth_date'</span>: datetime.<span class="dt">date</span>(<span class="dv">1990</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb12-7"><a></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>والآن نريد أن نرسل هذه الجملة كأوامِر لنظام قاعدة البيانات:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a></a><span class="cf">with</span> engine.<span class="ex">connect</span>() <span class="im">as</span> conn:</span>
<span id="cb13-2"><a></a>    result_cursor <span class="op">=</span> conn.execute(stmt)</span>
<span id="cb13-3"><a></a>    conn.commit()</span>
<span id="cb13-4"><a></a>    row <span class="op">=</span> result_cursor.fetchone()</span>
<span id="cb13-5"><a></a>    user_id <span class="op">=</span> row[<span class="dv">0</span>]</span>
<span id="cb13-6"><a></a>    <span class="bu">print</span>(user_id)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وإليك شرح هذه القطعة:</p>
<ol type="1">
<li>نأخذ اتصالاً من المحرِّك (<code>connect as conn</code>)</li>
<li>ونرسل من خلاله الجملة <code>execute(stmt)</code>، ثم نحصل على النتائج (<code>result_cursor</code>) الذي يطبِّق بروتوكول Cursor المعروف في DB-API</li>
<li>فنعرف أنه يمكننا من خلاله سحب صف واحد (<code>fetchone</code>)</li>
<li>ثم نأخذ أول نتيجة في هذا الصف (<code>[0]row</code>) لنحصل على <code>user_id</code></li>
</ol>
<p>الآن سنجمع هذه الخطوات ونضعها في دالة بايثون:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a></a><span class="kw">def</span> add_user(name: <span class="bu">str</span>, birth_date: datetime.date):</span>
<span id="cb14-2"><a></a>    stmt <span class="op">=</span> (</span>
<span id="cb14-3"><a></a>        insert(users_table)</span>
<span id="cb14-4"><a></a>        .values(</span>
<span id="cb14-5"><a></a>            name<span class="op">=</span>name,</span>
<span id="cb14-6"><a></a>            birth_date<span class="op">=</span>birth_date</span>
<span id="cb14-7"><a></a>        )</span>
<span id="cb14-8"><a></a>        .returning(users_table.c.<span class="bu">id</span>)</span>
<span id="cb14-9"><a></a>    )</span>
<span id="cb14-10"><a></a>    <span class="cf">with</span> engine.<span class="ex">connect</span>() <span class="im">as</span> conn:</span>
<span id="cb14-11"><a></a>        result <span class="op">=</span> conn.execute(stmt)</span>
<span id="cb14-12"><a></a>        conn.commit()</span>
<span id="cb14-13"><a></a>        row <span class="op">=</span> result.fetchone()</span>
<span id="cb14-14"><a></a>        user_id <span class="op">=</span> row[<span class="dv">0</span>]</span>
<span id="cb14-15"><a></a>        <span class="cf">return</span> user_id</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>ثم يكون استدعاؤها بهذا الشكل:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a></a>user_id <span class="op">=</span> add_user(</span>
<span id="cb15-2"><a></a>    name<span class="op">=</span><span class="st">"Adam Banana"</span>,</span>
<span id="cb15-3"><a></a>    birth_date<span class="op">=</span>datetime.date(<span class="dv">1990</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb15-4"><a></a>)</span>
<span id="cb15-5"><a></a><span class="bu">print</span>(user_id)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="إضافة-مجموعة-بيانات">إضافة مجموعة بيانات</h3>
<p>نريد أن نعيِّن مجموعة عنواين البريد الإلكتروني للمستخدم. وذلك يعني حذف كل القديم وإضافة القائمة الجديدة. تأمل المثال التالي وسنشرحه:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a></a><span class="kw">def</span> set_user_emails(user_id: <span class="bu">int</span>, emails: <span class="bu">list</span>[<span class="bu">str</span>]):</span>
<span id="cb16-2"><a></a>    <span class="cf">with</span> engine.<span class="ex">connect</span>() <span class="im">as</span> conn:</span>
<span id="cb16-3"><a></a>        conn.execute(</span>
<span id="cb16-4"><a></a>            delete(emails_table)</span>
<span id="cb16-5"><a></a>            .where(emails_table.c.user_id <span class="op">==</span> user_id)</span>
<span id="cb16-6"><a></a>        )</span>
<span id="cb16-7"><a></a>        result_cursor <span class="op">=</span> conn.execute(</span>
<span id="cb16-8"><a></a>            insert(emails_table).values([</span>
<span id="cb16-9"><a></a>                { <span class="st">"email"</span>: email, <span class="st">"user_id"</span>: user_id }</span>
<span id="cb16-10"><a></a>                <span class="cf">for</span> email <span class="kw">in</span> emails</span>
<span id="cb16-11"><a></a>            ])</span>
<span id="cb16-12"><a></a>        )</span>
<span id="cb16-13"><a></a>        conn.commit()</span>
<span id="cb16-14"><a></a>        <span class="cf">return</span> result_cursor.rowcount</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>عرفنا دالة في بايثون، تأخذ معرِّف المستخدم، وقائمة بالعناوين. ونحن نعلم أن العلاقة واحدة من طرف جدول المستخدم (<code>users_table</code>) ومتعددة من طرف جدول عناوين البريد الإكلتروني (<code>user_emails_table</code>)، وعليه كتبنا:</p>
<p>أولاً حذف القديم؛ وذلك بجملة الحذف (<code>delete</code>) حيث يتم تعيين الجدوَل المحذوف منه، ثم في جملة الشرط (<code>where</code>) يتم تحدد الشرط بالمسار (<code>emails_table.c.user_id</code>) حيث الحرف (<code>c</code>) هنا واسطة تتضمن أسماء الأعمدة الموجودة في الجدوَل؛ وهذا يعني أن بايثون تساعدنا في الإملاء إن أخطأنا.</p>
<p>إضافة الجديد، وربط كل صف بمعرِّف المتسخدم نفسه؛ وقد استعملنا جملة الإنشاء المختصر (comprehension) لقائمة مكوَّنة من قواميس (يعبَّر عنها هكذا: <code>list[dict]</code>)؛ في كل قاموس منها اسم العمود وما يقابله من قيمة.</p>
<p>ثم نستدعيها هكذا دون الحاجة لمعرفة التفاصيل (كيفية الإضافة)، وقد حصلنا على معرِّف المستخدم <code>user_id</code> من النص البرمجي السابق:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a></a>emails <span class="op">=</span> [</span>
<span id="cb17-2"><a></a>    <span class="st">"xyz@example.com"</span>,</span>
<span id="cb17-3"><a></a>    <span class="st">"abc@example.com"</span>,</span>
<span id="cb17-4"><a></a>    <span class="st">"def@example.com"</span>,</span>
<span id="cb17-5"><a></a>]</span>
<span id="cb17-6"><a></a>add_user_emails(user_id, emails)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="استعلام-الاختيار">استعلام الاختيار</h3>
<p>تأمل المثال التالي الذي نستعمل فيه جملة <code>select</code> ونشير إلى الأعمدة بمسار يبدأ من اسم الجدوَل ثم حرف (<code>c</code>) ثم اسم العمود (وبهذا ستضمن لنا بايثون صحة الإملاء):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a></a><span class="kw">def</span> get_user_emails(user_id: <span class="bu">int</span>):</span>
<span id="cb18-2"><a></a>    <span class="cf">with</span> engine.<span class="ex">connect</span>() <span class="im">as</span> conn:</span>
<span id="cb18-3"><a></a>        result_cursor <span class="op">=</span> conn.execute(</span>
<span id="cb18-4"><a></a>            select(emails_table.c.email)</span>
<span id="cb18-5"><a></a>            .where(emails_table.c.user_id <span class="op">==</span> user_id)</span>
<span id="cb18-6"><a></a>        )</span>
<span id="cb18-7"><a></a>        emails <span class="op">=</span> [row[<span class="dv">0</span>] <span class="cf">for</span> row <span class="kw">in</span> result_cursor]</span>
<span id="cb18-8"><a></a>        <span class="cf">return</span> emails</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وإليك شرح الزائد على ما تقدَّم، وهو السطر الأخير: فلأن النتيجة (<code>result_cursor</code>) تطبق آلية <code>Cursor</code> من البروتوكول DB-API؛ فإننا نعرف أنه يمكننا كرُّها باستعمال حلقة (<code>for</code>) على هذا النحو، وكل كرَّة ستنتج لنا صفًّا كاملاً لكننا نعلم أن فيه قيمة واحدة: <code>email</code> ولذلك نختار القيمة الأولى (<code>[0]row</code>) من كل صف من النتائج.</p>
<p>ثم نستديعها كأي دالة في بايثون على هذا النحو:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a></a>emails <span class="op">=</span> get_user_emails(user_id)</span>
<span id="cb19-2"><a></a><span class="bu">print</span>(emails)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="استعلام-التلخيص">استعلام التلخيص</h3>
<p>وأما الدوال، ومنها كلمات جمل الاختصار فيتم استيرادها على النحو التالي:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a></a><span class="im">from</span> sqlalchemy.sql.functions <span class="im">import</span> count, <span class="bu">sum</span>, <span class="bu">min</span>, <span class="bu">max</span>, mode</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>واستعمالها نحو هذا المثال، حيث نريد معرفة عدد العنواين لكل من المتسخدمين على حدة:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a></a><span class="kw">def</span> count_emails_per_user():</span>
<span id="cb21-2"><a></a>    <span class="cf">with</span> engine.<span class="ex">connect</span>() <span class="im">as</span> conn:</span>
<span id="cb21-3"><a></a>        result_cursor <span class="op">=</span> conn.execute(</span>
<span id="cb21-4"><a></a>            select(</span>
<span id="cb21-5"><a></a>                emails_table.c.user_id,</span>
<span id="cb21-6"><a></a>                count(emails_table.c.email)</span>
<span id="cb21-7"><a></a>            )</span>
<span id="cb21-8"><a></a>            .group_by(emails_table.c.user_id)</span>
<span id="cb21-9"><a></a>        )</span>
<span id="cb21-10"><a></a>        <span class="cf">return</span> result_cursor.fetchall()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>ثم استدعاؤها هكذا:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a></a><span class="bu">print</span>(count_emails_per_user())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="النزول-إلى-كتابة-نص-sql-خام" class="slide level2">
<h2>النزول إلى كتابة نص SQL خام</h2>
<p>من مميزات SQLAlchemy أنها تسمح بخرق التجريد والنزول إلى مستوى كتابة SQL يدويًّا حين يتطلَّب الأمر ذلك.</p>
<h3 id="استبدال-كلي">استبدال كلي</h3>
<p>الطريقة الأولى: استبدال كُلِّي باستعمال <code>text</code> ثم ربط المتغيرات بقيمها:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a></a><span class="im">from</span> sqlalchemy <span class="im">import</span> select, text</span>
<span id="cb23-2"><a></a></span>
<span id="cb23-3"><a></a>sql_text <span class="op">=</span> text(</span>
<span id="cb23-4"><a></a>    <span class="st">"SELECT name, salary"</span></span>
<span id="cb23-5"><a></a>    <span class="st">"FROM employees"</span></span>
<span id="cb23-6"><a></a>    <span class="st">"WHERE department = :var_name"</span></span>
<span id="cb23-7"><a></a>      <span class="st">"AND salary &gt; :var_salary"</span></span>
<span id="cb23-8"><a></a>)</span>
<span id="cb23-9"><a></a></span>
<span id="cb23-10"><a></a>parameters <span class="op">=</span> {</span>
<span id="cb23-11"><a></a>    <span class="st">"var_name"</span>: <span class="st">"Sales"</span>,</span>
<span id="cb23-12"><a></a>    <span class="st">"var_salary"</span>: <span class="dv">50000</span></span>
<span id="cb23-13"><a></a>}</span>
<span id="cb23-14"><a></a></span>
<span id="cb23-15"><a></a><span class="cf">with</span> engine.<span class="ex">connect</span>() <span class="im">as</span> conn:</span>
<span id="cb23-16"><a></a>    result <span class="op">=</span> conn.execute(sql_text, parameters)</span>
<span id="cb23-17"><a></a>    <span class="cf">for</span> row <span class="kw">in</span> result:</span>
<span id="cb23-18"><a></a>        <span class="bu">print</span>(<span class="ss">f"Name: </span><span class="sc">{</span>row<span class="sc">.</span>name<span class="sc">}</span><span class="ss">, Salary: </span><span class="sc">{</span>row<span class="sc">.</span>salary<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>قد تتساءل لماذا لا نكتب قيمة المتغيرات مباشرة؟ والجواب عن ذلك يكمن في أن تمرير المعطيات الآتية من نظام خارجي قد يعرضنا <strong>لاخراق حقن SQL</strong> المسمى (SQL Injection). لذلك يتم الفصل بين القالب النصي (<code>text</code>) وبين المتغيرات <code>parameters</code>.</p>
<p>وفائدة أخرى هي الاقتصاد المؤدي للسرعة. فقد يُحفَظُ القالب إن تكرر كثيرًا إرسال نفس الجُملة، وبالتالي لا نحتاج إلا لإرسال إشارة إليها في ذاكرة خادم قاعدة البيانات، وبذلك نوفِّر في موارد الشبكة وموارد المعالجة، ونجعل النتيجة أسرع.</p>
<h3 id="استبدال-جزئي">استبدال جزئي</h3>
<p>الطريقة الثانية: استبدال جُزئي باستعمال <code>literal_column</code>، وذلك على النحو التالي:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a></a><span class="im">from</span> sqlalchemy <span class="im">import</span> select, literal_column</span>
<span id="cb24-2"><a></a></span>
<span id="cb24-3"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb24-4"><a></a>    select(</span>
<span id="cb24-5"><a></a>        employees_table.c.name,</span>
<span id="cb24-6"><a></a>        literal_column(<span class="st">"salary * 1.15"</span>).label(<span class="st">"new_salary"</span>)</span>
<span id="cb24-7"><a></a>    )</span>
<span id="cb24-8"><a></a>    .order_by(literal_column(<span class="st">"new_salary"</span>).desc())</span>
<span id="cb24-9"><a></a>)</span>
<span id="cb24-10"><a></a><span class="bu">print</span>(stmt)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>لتظهر نتيجة الجملة عند الطباعة:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><a></a><span class="kw">SELECT</span></span>
<span id="cb25-2"><a></a>    employees.name,</span>
<span id="cb25-3"><a></a>    salary <span class="op">*</span> <span class="fl">1.15</span> <span class="kw">AS</span> new_salary</span>
<span id="cb25-4"><a></a><span class="kw">FROM</span> employees</span>
<span id="cb25-5"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> new_salary <span class="kw">DESC</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section>
<section id="خلاصة" class="title-slide slide level1 center">
<h1>خلاصة</h1>
<p>إنّ <strong>SQLAlchemy</strong> يرفع العمل مع قواعد البيانات من وحل السائقين إلى طبقةٍ أرقى؛ فيجعل <strong>المحرّك</strong> أصل التعامل، يتولّى صوغ نصّ الاتصال، وضبط اللهجة، وإدارة مجمّع الاتصالات. ثم تُحدَّد البنية عبر <strong>Metadata</strong> وجداولٍ ذات أعمدة وقيود، فتُترجم إلى DDL عند الطلب. وبعد تثبيت المخطّط تُنشأ عبارات الإدراج والاختيار والتعديل بوسائط بايثونية تُحوَّل إلى SQL منقَّح، ويُستعاد الناتج على هيئة صفوفٍ تمضي كما يمضي المؤشّر في DB-API. ولمن أراد النفاذ إلى العمق، فالإطار يفتح باب <strong>SQL الخام</strong> بلا تجريد، مع حفظٍ للأمن عبر الفصل بين القالب والمعطيات.</p>
<p>السؤال التالي: ما هي الطريقة السليمة لتطوير مخطط قاعدة البيانات بحيث نتجنَّب خسارة البيانات أو تعارض المخطط التجريبي مع المخطط الحقيقي؟</p>
</section>
<section id="ملحق" class="slide level2">
<h2>ملحق</h2>
<p>في هذا الملحق نُدرِج الأمثلة التي رأيناها في درس <strong>لغة البيانات</strong> لأنها تستعرض خصائص مختلفة من SQL.</p>
<p>نبدأ أولاً بتعريف الجداول:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a></a><span class="im">from</span> sqlalchemy.schema <span class="im">import</span> MetaData, Table, Column, ForeignKey</span>
<span id="cb26-2"><a></a><span class="im">from</span> sqlalchemy.types <span class="im">import</span> DateTime, Integer, String</span>
<span id="cb26-3"><a></a></span>
<span id="cb26-4"><a></a>metadata <span class="op">=</span> MetaData()</span>
<span id="cb26-5"><a></a></span>
<span id="cb26-6"><a></a>products_table <span class="op">=</span> Table(</span>
<span id="cb26-7"><a></a>    <span class="st">"products"</span>,</span>
<span id="cb26-8"><a></a>    metadata,</span>
<span id="cb26-9"><a></a>    Column(<span class="st">"id"</span>, Integer, primary_key<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb26-10"><a></a>    Column(<span class="st">"name"</span>, String),</span>
<span id="cb26-11"><a></a>    Column(<span class="st">"price"</span>, Integer),</span>
<span id="cb26-12"><a></a>)</span>
<span id="cb26-13"><a></a></span>
<span id="cb26-14"><a></a>orders_table <span class="op">=</span> Table(</span>
<span id="cb26-15"><a></a>    <span class="st">"orders"</span>,</span>
<span id="cb26-16"><a></a>    metadata,</span>
<span id="cb26-17"><a></a>    Column(<span class="st">"id"</span>, Integer, primary_key<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb26-18"><a></a>    Column(<span class="st">"order_datetime"</span>, DateTime),</span>
<span id="cb26-19"><a></a>    Column(<span class="st">"customer_id"</span>, Integer, ForeignKey(<span class="st">"customers.id"</span>)),</span>
<span id="cb26-20"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="المثال-الأول-الشروط">المثال الأول: الشروط</h3>
<p>الاستعلام: اختر الزبائن من دولة “ألمانيا”، والذين أعمارهم إما تحت 40 وإما فوق 60:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb27-1"><a></a><span class="kw">SELECT</span> name <span class="kw">FROM</span> Customers</span>
<span id="cb27-2"><a></a><span class="kw">WHERE</span> Country <span class="op">=</span> <span class="st">'Germany'</span></span>
<span id="cb27-3"><a></a>&nbsp; <span class="kw">AND</span> (Age <span class="op">&lt;</span> <span class="dv">40</span> <span class="kw">OR</span> Age <span class="op">&gt;</span> <span class="dv">60</span>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وما يقابلها في بايثون:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a></a><span class="im">from</span> sqlalchemy <span class="im">import</span> select, or_</span>
<span id="cb28-2"><a></a></span>
<span id="cb28-3"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb28-4"><a></a>    select(</span>
<span id="cb28-5"><a></a>        customers_table.c.name</span>
<span id="cb28-6"><a></a>    )</span>
<span id="cb28-7"><a></a>    .where(customers_table.c.country <span class="op">==</span> <span class="st">'Germany'</span>)</span>
<span id="cb28-8"><a></a>    .where(or_(</span>
<span id="cb28-9"><a></a>        customers_table.c.age <span class="op">&lt;</span> <span class="dv">40</span>,</span>
<span id="cb28-10"><a></a>        customers_table.c.age <span class="op">&gt;</span> <span class="dv">60</span></span>
<span id="cb28-11"><a></a>        )</span>
<span id="cb28-12"><a></a>    )</span>
<span id="cb28-13"><a></a>)</span>
<span id="cb28-14"><a></a><span class="bu">print</span>(stmt)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>لاحظ أننا نضطر لوضع شرطة سفلية في كلمة <code>_or</code> لأنها من غيرها محجوزة ضمن كلمات لغة بايثون، وكذلك الأمر في <code>_and</code> لكننا لم نحتج إلى استعمالها، إذ تكرار <code>where</code> مكافئ لها.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb29-1"><a></a><span class="kw">SELECT</span> customers.name</span>
<span id="cb29-2"><a></a><span class="kw">FROM</span> customers</span>
<span id="cb29-3"><a></a><span class="kw">WHERE</span> customers.country <span class="op">=</span> <span class="ch">:country_1</span></span>
<span id="cb29-4"><a></a>  <span class="kw">AND</span> (customers.age <span class="op">&lt;</span> <span class="ch">:age_1</span> <span class="kw">OR</span> customers.age <span class="op">&gt;</span> <span class="ch">:age_2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="المثال-الثاني-الترتيب-والحد">المثال الثاني: الترتيب والحد</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb30-1"><a></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> Products</span>
<span id="cb30-2"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> Price <span class="kw">DESC</span></span>
<span id="cb30-3"><a></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb31-2"><a></a>    select(products_table)</span>
<span id="cb31-3"><a></a>    .order_by(products_table.c.price.desc())</span>
<span id="cb31-4"><a></a>    .limit(<span class="dv">5</span>)</span>
<span id="cb31-5"><a></a>)</span>
<span id="cb31-6"><a></a><span class="bu">print</span>(stmt)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>نتيجة الطباعة:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb32-1"><a></a><span class="kw">SELECT</span> products.<span class="kw">id</span>, products.name, products.price</span>
<span id="cb32-2"><a></a><span class="kw">FROM</span> products</span>
<span id="cb32-3"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> products.price <span class="kw">DESC</span></span>
<span id="cb32-4"><a></a><span class="kw">LIMIT</span> <span class="ch">:param_1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="المثال-الثالث-نفي-العضوية">المثال الثالث: نفي العضوية</h3>
<p>الاستعلام: أريد الزبائن الذين ليسوا من دولة كذا وكذا وكذا:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb33-1"><a></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> customers</span>
<span id="cb33-2"><a></a><span class="kw">WHERE</span> country <span class="kw">NOT</span> <span class="kw">IN</span> (<span class="st">'Germany'</span>, <span class="st">'France'</span>, <span class="st">'UK'</span>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a></a>block_list <span class="op">=</span> [<span class="st">'Germany'</span>, <span class="st">'France'</span>, <span class="st">'UK'</span>]</span>
<span id="cb34-2"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb34-3"><a></a>    select(customers_table)</span>
<span id="cb34-4"><a></a>    .where(customers_table.c.country.notin_(block_list))</span>
<span id="cb34-5"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="المثال-الرابع-دمج-الجداول">المثال الرابع: دمج الجداول</h3>
<p>استعلام: أريد أسماء المنتجات وأسعارها ومعرِّف الطلب من الطلبات التي حصلت في النصف الأول من السنة:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb35-1"><a></a><span class="kw">SELECT</span> orders.<span class="kw">id</span>, products.name, products.price</span>
<span id="cb35-2"><a></a><span class="kw">FROM</span> orders <span class="kw">JOIN</span> products</span>
<span id="cb35-3"><a></a>  <span class="kw">ON</span> orders.<span class="kw">id</span> <span class="op">=</span> products.<span class="kw">id</span></span>
<span id="cb35-4"><a></a><span class="kw">WHERE</span> orders.order_datetime <span class="kw">BETWEEN</span> <span class="st">'1996-01-01'</span> <span class="kw">AND</span> <span class="st">'1996-06-01'</span>;</span>
<span id="cb35-5"><a></a>  ;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb36-2"><a></a>    select(</span>
<span id="cb36-3"><a></a>        orders_table.c.<span class="bu">id</span>,</span>
<span id="cb36-4"><a></a>        products_table.c.name,</span>
<span id="cb36-5"><a></a>        products_table.c.price</span>
<span id="cb36-6"><a></a>    )</span>
<span id="cb36-7"><a></a>    .join(products_table, orders_table.c.<span class="bu">id</span> <span class="op">==</span> products_table.c.<span class="bu">id</span>)</span>
<span id="cb36-8"><a></a>    .where(orders_table.c.order_datetime.between(<span class="st">'1996-01-01'</span>, <span class="st">'1996-06-01'</span>))</span>
<span id="cb36-9"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="المثال-الخامس-الترشيح-قبل-وبعد-التجميع">المثال الخامس: الترشيح قبل وبعد التجميع</h3>
<p>وهذا المثال يحتاج إلى جدوَل الطلبة، فننشئه على هذا النحو:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a></a>students_table <span class="op">=</span> Table(</span>
<span id="cb37-2"><a></a>    <span class="st">"students"</span>,</span>
<span id="cb37-3"><a></a>    metadata,</span>
<span id="cb37-4"><a></a>    Column(<span class="st">"id"</span>, Integer, primary_key<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb37-5"><a></a>    Column(<span class="st">"name"</span>, String),</span>
<span id="cb37-6"><a></a>    Column(<span class="st">"country"</span>, String),</span>
<span id="cb37-7"><a></a>    Column(<span class="st">"score"</span>, Integer),</span>
<span id="cb37-8"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>جملة الاستعلام: متوسط نقاط الطلبة الناجحين (فوق 60 درجة) بحسب الدولة (يرشح من ذلك الدول التي يتجاوز متوسطها 90):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb38-1"><a></a><span class="kw">SELECT</span> country, (<span class="fu">SUM</span>(score) <span class="op">/</span> <span class="fu">COUNT</span>(<span class="kw">id</span>)) <span class="kw">AS</span> <span class="fu">avg</span></span>
<span id="cb38-2"><a></a><span class="kw">FROM</span> students</span>
<span id="cb38-3"><a></a><span class="kw">WHERE</span> score <span class="op">&gt;=</span> <span class="dv">60</span></span>
<span id="cb38-4"><a></a><span class="kw">GROUP</span> <span class="kw">BY</span> country</span>
<span id="cb38-5"><a></a><span class="kw">HAVING</span> avg_score_per_country <span class="op">&gt;</span> <span class="dv">90</span></span>
<span id="cb38-6"><a></a><span class="kw">ORDER</span> <span class="kw">BY</span> avg_score_per_country <span class="kw">DESC</span>;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وهذا مقابله في بايثون:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a></a>total_score <span class="op">=</span> func.<span class="bu">sum</span>(students_table.c.score).label(<span class="st">'total_score'</span>)</span>
<span id="cb39-2"><a></a></span>
<span id="cb39-3"><a></a>count_score <span class="op">=</span> func.count(students_table.c.score).label(<span class="st">'count_score'</span>)</span>
<span id="cb39-4"><a></a></span>
<span id="cb39-5"><a></a>avg_score_per_country <span class="op">=</span> (total_score <span class="op">/</span> count_score).label(<span class="st">'avg'</span>)</span>
<span id="cb39-6"><a></a></span>
<span id="cb39-7"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb39-8"><a></a>    select(students_table.c.country, avg_score_per_country)</span>
<span id="cb39-9"><a></a>    .where(students_table.c.score <span class="op">&gt;=</span> <span class="dv">60</span>)</span>
<span id="cb39-10"><a></a>    .group_by(students_table.c.country)</span>
<span id="cb39-11"><a></a>    .having(avg_score_per_country <span class="op">&gt;</span> <span class="dv">90</span>)</span>
<span id="cb39-12"><a></a>    .order_by(avg_score_per_country.desc())</span>
<span id="cb39-13"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<h3 id="المثال-السادس-جملة-الاختيار-المركبة">المثال السادس: جملة الاختيار المركبة</h3>
<p>تعريف الجداول في بايثون:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a></a>departments_table <span class="op">=</span> Table(</span>
<span id="cb40-2"><a></a>    <span class="st">"departments"</span>,</span>
<span id="cb40-3"><a></a>    metadata,</span>
<span id="cb40-4"><a></a>    Column(<span class="st">"id"</span>, Integer, primary_key<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb40-5"><a></a>    Column(<span class="st">"name"</span>, String),</span>
<span id="cb40-6"><a></a>)</span>
<span id="cb40-7"><a></a></span>
<span id="cb40-8"><a></a>employees_table <span class="op">=</span> Table(</span>
<span id="cb40-9"><a></a>    <span class="st">"employees"</span>,</span>
<span id="cb40-10"><a></a>    metadata,</span>
<span id="cb40-11"><a></a>    Column(<span class="st">"id"</span>, Integer, primary_key<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb40-12"><a></a>    Column(<span class="st">"dep_id"</span>, Integer, ForeignKey(<span class="st">"departments.id"</span>)),</span>
<span id="cb40-13"><a></a>    Column(<span class="st">"salary"</span>, Integer),</span>
<span id="cb40-14"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>جملة الاستعلام: أريد أسماء الأقسام التي لديها موظفين رواتبهم تتجاوز التسعة آلاف.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb41-1"><a></a><span class="kw">SELECT</span> name <span class="kw">FROM</span> Departments</span>
<span id="cb41-2"><a></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="kw">IN</span> (</span>
<span id="cb41-3"><a></a>    <span class="kw">SELECT</span> dep_id <span class="kw">FROM</span> Employees</span>
<span id="cb41-4"><a></a>    <span class="kw">WHERE</span> salary <span class="op">&gt;</span> <span class="dv">9000</span>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>وفي بايثون:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a></a>stmt <span class="op">=</span> (</span>
<span id="cb42-2"><a></a>    select(departments_table.c.name)</span>
<span id="cb42-3"><a></a>    .where(departments_table.c.<span class="bu">id</span>.in_(</span>
<span id="cb42-4"><a></a>        select(employees_table.c.dep_id)</span>
<span id="cb42-5"><a></a>        .where(employees_table.c.salary <span class="op">&gt;</span> <span class="dv">9000</span>)</span>
<span id="cb42-6"><a></a>    ))</span>
<span id="cb42-7"><a></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="../../../assets/icon.svg" class="slide-logo"></p>
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../../../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../../../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../../../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../../../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../../../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../../../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../../../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../../../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"},{"title":"Index","icon":"<svg width='1.8rem' viewBox='0 0 24 24'><path d='M5 7h14M5 12h14M5 17h7' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>","src":"../index.html"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: false,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: true,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'fade',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>